{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2 class="mb-4">Job Application Form</h2>
    <div class="card">
        <div class="card-body">
            <form id="initialForm" onsubmit="startQuiz(event)">
                <div class="mb-3">
                    <label for="name" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>

                <div class="mb-3">
                    <label for="phone" class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="phone" name="phone" required>
                </div>

                <div class="mb-3">
                    <label for="qualification" class="form-label">Qualification</label>
                    <input type="text" class="form-control" id="qualification" name="qualification" required>
                </div>

                <div class="mb-3">
                    <label for="experience" class="form-label">Years of Experience</label>
                    <input type="number" class="form-control" id="experience" name="experience" min="0" required>
                </div>

                <button type="submit" class="btn btn-primary">Start Skill Assessment</button>
            </form>

            <div id="quizSection" class="mt-4" style="display: none;">
                <h3 class="mb-4">Skill Assessment Test</h3>
                <div id="questionContainer">
                    <!-- Questions will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/questions.js') }}"></script>
<script>
let currentQuestion = 0;
let score = 0;
let selectedJob = '';
let applicationData = null;

function startQuiz(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    applicationData = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        qualification: formData.get('qualification'),
        experience: formData.get('experience'),
        jobTitle: new URLSearchParams(window.location.search).get('job')?.trim() || ""
    };

    selectedJob = applicationData.jobTitle;
    if (!selectedJob || !jobQuestions[selectedJob]) {
        alert('Invalid job selection');
        window.location.href = '/';
        return;
    }

    document.getElementById('initialForm').style.display = 'none';
    document.getElementById('quizSection').style.display = 'block';
    displayQuestion();
}

function displayQuestion() {
    const questions = jobQuestions[selectedJob];
    if (currentQuestion >= questions.length) {
        evaluateQuiz();
        return;
    }

    const question = questions[currentQuestion];
    const container = document.getElementById('questionContainer');

    container.innerHTML = `
        <h4 class="mb-3">Question ${currentQuestion + 1} of 5</h4>
        <p class="mb-3">${question.question}</p>
        <div class="options-container">
            ${question.options.map((option, index) => `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="question${currentQuestion}" value="${index}" id="option${index}">
                    <label class="form-check-label" for="option${index}">
                        ${option}
                    </label>
                </div>
            `).join('')}
        </div>
        <button onclick="submitAnswer()" class="btn btn-primary mt-3">
            ${currentQuestion === questions.length - 1 ? 'Finish Quiz' : 'Next Question'}
        </button>
    `;
}

function submitAnswer() {
    const selectedOption = document.querySelector(`input[name="question${currentQuestion}"]:checked`);
    if (!selectedOption) {
        alert('Please select an answer');
        return;
    }

    const questions = jobQuestions[selectedJob];
    if (parseInt(selectedOption.value) === questions[currentQuestion].correct) {
        score++;
    }

    currentQuestion++;
    displayQuestion();
}

function evaluateQuiz() {
    const container = document.getElementById('questionContainer');
    const percentage = (score / 5) * 100;

    if (percentage >= 80) {
        container.innerHTML = `
            <div class="alert alert-success">
                <h4>Congratulations!</h4>
                <p>You have passed the test. We will soon get in touch with you.</p>
                <p>Your score: ${percentage}%</p>
            </div>
        `;
        submitApplication(percentage);
    } else {
        container.innerHTML = `
            <div class="alert alert-danger">
                <h4>Unfortunately</h4>
                <p>You are unable to clear the test. Better luck next time.</p>
                <p>Your score: ${percentage}%</p>
                <a href="/" class="btn btn-primary mt-3">Back to Jobs</a>
            </div>
        `;
    }
}

function submitApplication(quizScore) {
    if (!applicationData) return;

    applicationData.date = new Date().toLocaleDateString();
    applicationData.score = quizScore; // Add the quiz score to the application data

    let applications = JSON.parse(localStorage.getItem('applications')) || [];
    applications.push(applicationData);
    localStorage.setItem('applications', JSON.stringify(applications));

    setTimeout(() => {
        window.location.href = '/';
    }, 3000);
}

</script>
{% endblock %}